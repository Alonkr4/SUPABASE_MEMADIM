CREATE TABLE IF NOT EXISTS ak_analytics.urgency_metrics (
    -- CORE
    deal_id                         TEXT PRIMARY KEY,
    updated_at                      TIMESTAMPTZ DEFAULT NOW(),

    -- ACTIVITY
    chat_activity_all               NUMERIC(10,2),
    chat_activity_60d               NUMERIC(10,2),
    activity_30                     NUMERIC(10,2),
    activity_prev30                 NUMERIC(10,2),
    surveys_activity                NUMERIC(6,2),
    weighs_activity                 NUMERIC(6,2),
    want_clinic_bonus               NUMERIC(6,2),
    activity_final                  NUMERIC(6,2),

    -- SATISFACTION
    satisfaction_service            NUMERIC(6,2),
    satisfaction_progress           NUMERIC(6,2),
    satisfaction_app                NUMERIC(6,2),
    satisfaction_base               NUMERIC(6,2),
    satisfaction_cons_opinion       NUMERIC(6,2),
    satisfaction_retention_penalty  NUMERIC(6,2),
    satisfaction_clinic_bonus       NUMERIC(6,2),
    satisfaction_final              NUMERIC(6,2),

    -- PROGRESS
    progress_score_total            NUMERIC(6,2),
    progress_score_2m               NUMERIC(6,2),
    progress_sat_score              NUMERIC(6,2),
    progress_base                   NUMERIC(6,2),
    progress_change_dir_override    NUMERIC(6,2),
    progress_cons_bonus             NUMERIC(6,2),
    progress_final                  NUMERIC(6,2),

    -- URGENCY
    urgency_raw                     NUMERIC(10,2),
    urgency_status_penalty          NUMERIC(6,2),
    urgency_temp_bonus              NUMERIC(6,2),
    urgency_stressed_bonus          NUMERIC(6,2),
    urgency_accurate_bonus          NUMERIC(6,2),
    urgency_first_months_bonus      NUMERIC(6,2),
    urgency_sat_activity_penalty    NUMERIC(6,2),
    urgency_low_sat_bonus           NUMERIC(6,2),
    urgency_low_progress_bonus      NUMERIC(6,2),
    urgency_score_final             NUMERIC(10,2),
    urgency_percentile              NUMERIC(5,2),
    urgency_tag                     TEXT,

    -- EXCLUSION
    is_excluded                     BOOLEAN DEFAULT FALSE
);

CREATE INDEX IF NOT EXISTS idx_um_tag 
    ON ak_analytics.urgency_metrics (urgency_tag);

CREATE INDEX IF NOT EXISTS idx_um_score 
    ON ak_analytics.urgency_metrics (urgency_score_final DESC);

CREATE INDEX IF NOT EXISTS idx_um_excluded 
    ON ak_analytics.urgency_metrics (is_excluded) 
    WHERE is_excluded = FALSE;
